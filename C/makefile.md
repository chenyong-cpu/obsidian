# Makefile语法

## 简介

Makefile可以简单的认为是一个工程文件的编译规则，描述了整个工程的自动编译和链接的规则。
Makefile里主要包含了五个东西：显示规则、隐晦规则、变量定义、文件指示和注释。

1. 显示规则

	显示规则说明了，如何生成一个或多个目标文件。这是由Makefile的书写作者明显指出，要生成的文件，文件的依赖文件，生成的命令。

2. 隐晦规则

	我们的make命名有自动推导的功能，所以隐晦的规则可以让我们比较粗糙地简陋的书写Makefile,这是make命令所支持的。

3. 变量的定义

	在Makefile中我们要定义一系列的变量，变量一般都是字符串，这个有点像C语言中的宏，当Makefile被执行时，其中的变量都会被扩展到相应的引用位置上。

4. 文件指示

	其包括了三个部分，一个是在一个Makefile中引用另一个Makefile,一个是根据不同的情况指定有效的部分，一个是执行一个多行的命令

5. 注释

	使用“#”进行注释

**基本格式如下：**

```makefile
targets: prerequisites
	command
targets：规则的目标，可以是中间文件、可执行文件、标签
prerequisites：依赖文件
command：需要执行的命令
```

## 常用规则介绍

### 递归扩展变量

|变量|解析|
|---|---|
|=|最基本的赋值|
|:=|覆盖之前的值|
|?=|如果之前没有赋值过就赋予等号后面的值|
|+=|添加等号后面的值|
|obj-y:=|编译进内核的文件（夹）列表|
|obj-m:=|编译成外部可加载模块的列表|
|lib-y:=和lib-m:=|编译成库文件|
|always:=|总是要被编译的模块|
|targets:=|编译目标|
|subdir-y:=和subdir-m:=|表示需要递归进入的子目录|

### 常见的自动化变量解析

|变量|解析|
|---|---|
|$0|当前脚本的文件名|
|$n(n>0)|传递给脚本或者函数的参数|
|$#|传递给脚本的参数个数|
|$\*|传递给脚本或函数的所有参数|
|$@|表示目标文件|
|$\?|上个命令的退出状态，或函数的返回值|
|$\$|当前shell进程的ID|
|$^|表示所有的依赖文件|
|$<|表示第一个依赖文件|

### 常用的编译器宏定义

|宏定义|含义|
|---|---|
|AR|归档维护程序的名称，默认值为ar|
|ARFLAGS|归档维护程序的选项|
|AS|汇编程序的名称，默认值为as|
|ASFLAGS|汇编程序的选项|
|CC|C编译器的名称，默认值为cc|
|CCFLAGS|C编译器的选项|
|CPP|C预编译器的名称，默认值为$(CC) -E|
|CPPFLAGS|C预编译的选项|
|CXX|C++编译器的名称，默认值为g++|
|CXXFLAGS|C++编译器的选项|
|FC|FORTRAN编译器的名称，默认值为f77|
|FFLAGS|FORTRAN编译器的选项|

### 条件语法

当make看到条件语法时将⽴即对其进⾏分析，这包括 ifdef、ifeq、ifndef和ifneq四种语句形式。

### 其他特殊变量

1. VPATH

	Makefile文件中的特殊变量“VPATH”就是完成这个功能的，如果没有指明这个变量，make只会在当前的目录中去找寻依赖文件和目标文件。如果定义了这个变量，那么，make就会在当当前目录找不到的情况下，到所指定的目录中去找寻文件了

2. .PHONY变量

	因为，我们并不生成“clean”这个文件。“伪目标”并不是一个文件，只是一个标签，由于“伪目标”不是文件，所以make无法生成它的依赖关系和决定它是否要执行。我们只有通过显示地指明这个“目标”才能让其生效。当然，“伪目标”的取名不能和文件名重名，不然其就失去了“伪目标”的意义了。
	当然，为了避免和文件重名的这种情况，我们可以使用一个特殊的标记“.PHONY”来显示地指明一个目标是“伪目标”，向make说明，不管是否有这个文件，这个目标就是“伪目标”。

### include变量

	"include"指示符告诉 make 暂停读取当前的Makefile，而转去读取"include"指定的一个或者多个文件，完成以后再继续当前 Makefile 的读取。
	为什么要include其他文件呢?
	对于一些通用的变量定义、通用规则，写在一个文件中，任意目录结构中的makefile想要使用这些通用的变量或规则时，include指定的文件就好了，而不用在每个makefile中又重写一遍。
	对于源文件自动生成依赖文件(makefile之目录搜索＆自动依赖)时，将这些个依赖关系保存成文件，在需要使用时include进来，这样少了人为的干预，同时也减少的错误的发生
	我们就不希望mkdir出错而终止规则的运行。
	为了做到这一点，忽略命令的出错，我们可以在Makefile的命令行前加一个减号“-”（在Tab键之后），标记为不管命令出不出错都认为是成功的。
	“-include” 来代替 “include” 来忽略文件不存在或者是无法创建的错误提示，使用格式如下：-include


